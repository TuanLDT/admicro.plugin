/*! Sohahls - v0.0.1 - 2015-03-26
* Copyright (c) 2015 Le Dac Thanh Tuan; Licensed Apache-2.0 */
!function(e,t){"use strict";var r=1.1;t.HlSoha=t.Hls.extend({init:function(e,r,s){var i=r.source,n=e.options();e.hlSoha=this,delete r.source,r.swf=n.flash.swf||"http://s.vcplayer.vcmedia.vn/skin/VCPlayer.swf",t.Hls.call(this,e,r,s),r.source=i,this.bytesReceived=0,this.p2pInit(),this.currentTime=t.HlSoha.prototype.currentTime,this.setCurrentTime=t.HlSoha.prototype.setCurrentTime,e.on("segLoadError",t.bind(this,this.segLoadErrorHandler)),e.on("loaderError",t.bind(this,this.manifestErrorHandler)),t.HlSoha.prototype.src.call(this,r.source&&r.source.src)}}),t.options.techOrder.unshift("hlSoha"),t.HlSoha.prototype.dispose=function(){var e=this.player();e.off("segLoadError",this.segLoadErrorHandler),e.off("loaderError",this.manifestErrorHandler),t.Hls.prototype.dispose.call(this)},t.HlSoha.prototype.cancelSegmentXhr=function(){var e=0;if(this.segmentXhrs_){var t=_.keys(this.segmentXhrs_);for(e=0;e<t.length;e++)"XMLHttpRequest"==this.segmentXhrs_[t[e]].constructor.name&&(this.segmentXhrs_[t[e]].onreadystatechange=null,this.segmentXhrs_[t[e]].abort()),delete this.segmentXhrs_[t[e]];this.segmentXhrs_=null}this.firstSegment=!1},t.HlSoha.prototype.setCurrentTime=function(e){t.Hls.prototype.setCurrentTime.call(this,e),this.p2pReset()},t.HlSoha.prototype.fillBuffer=function(e){var r,s=this,i=this.player(),n=(i.buffered(),0);if(this.segmentXhrs_=this.segmentXhrs_||{},"HAVE_NOTHING"!==this.playlists.state&&this.playlists.media().segments&&(r=this.playlists.media().segments[this.mediaIndex],r&&!("number"!=typeof e&&n>=t.Hls.GOAL_BUFFER_LENGTH)))for(var a=this.fillSegments(e),o=0;o<a.length;o++){var l=this.playlists.media().segments[a[o]];if(l){var h=this.playlistUriToUrl(l.uri);this.loadSegment1(h,e,a[o])}else delete s.segmentXhrs_[a[o]]}},t.HlSoha.prototype.fillSegments=function(e){var r=this,s=this.player(),i=s.buffered(),n=0,a=0,o=[],l=!1,h=this.type=this.playlists.media().endList?1:0;i&&(a=n=s.buffered().end(0)-s.currentTime(),l=n>=3?!0:!1);var d=_.keys(r.segmentXhrs_);if(d.length>=3)return[];for(var u=0;u<d.length;u++)d[u]=parseInt(d[u]);for(var u=0;u<r.segmentBuffer_.length;u++)r.segmentBuffer_[u]&&o.push(r.segmentBuffer_[u].mediaIndex);for(var p=d.concat(o),u=0;u<p.length;u++){var m=this.playlists.media().segments[p[u]];m&&(a+=m.duration)}if("number"!=typeof e&&a>t.Hls.GOAL_BUFFER_LENGTH&&this.firstSegment)return[];var f=_.max(p),c=Math.max(this.mediaIndex,f+1,0);if(0==c)return[0];var g,y=!this.isRetrySegment,S=0==this.delayLevel?1:0;try{g=Math.max(1,Math.floor(r.bandwidth/this.playlists.media().attributes.BANDWIDTH))}catch(v){g=1}for(var L=Math.min(g,.5*this.currentLevel*h*this.firstSegment*l*S*y+1)-d.length,H=[],u=0;L>u;u++)r.segmentXhrs_[c+u]={},H.push(c+u);return H},t.HlSoha.prototype.loadSegment=function(e,t){{var r=this,s=this.player();s.options().hls||{}}r.p2phls.requestResource(e,function(){r.setBandwidth(this),r.segmentBuffer_.push({mediaIndex:r.mediaIndex,playlist:r.playlists.media(),offset:t,bytes:new Uint8Array(this.response)}),r.drainBuffer(),r.mediaIndex++,r.playlists.media(r.selectPlaylist()),this.onDecodeSuccess()})},t.HlSoha.prototype.loadSegment1=function(e,r,s){var i,n=this,a=this.player(),o=a.options().hls||{};this.segmentXhrs_[s]=i=t.Hls.xhr({url:e,responseType:"arraybuffer",withCredentials:o.withCredentials},function(e,t){if(delete n.segmentXhrs_[s],e)return"timeout"===e?(n.bandwidth=1,n.cancelSegmentXhr,n.segmentBuffer_=[],n.playlists.media(n.selectPlaylist())):(n.error={status:this.status,segIndex:s,message:"HLS segment request error at URL: "+t,code:this.status>=500?4:2},void a.trigger("segLoadError",n.error));if(this.response)for(n.setBandwidth(this),n.firstSegment=!0,n.isRetrySegment=!1,n.segSquenceError=0,n.segmentBuffer_[(s-n.mediaIndex)*n.type]={mediaIndex:s,playlist:n.playlists.media(),offset:r,bytes:new Uint8Array(this.response)};n.segmentBuffer_[0];)n.mediaIndex++,n.drainBuffer(),n.playlists.media(n.selectPlaylist())})},t.HlSoha.prototype.selectPlaylist=function(){var e,s,i,n,a,o=this.player(),l=this.playlists.master.playlists.slice(),h=[],d=l.length;for(l.sort(t.Hls.comparePlaylistBandwidth);d--;)i=l[d],i.attributes&&i.attributes.BANDWIDTH&&(e=i.attributes.BANDWIDTH*r,e<o.hlSoha.bandwidth&&(h.push(i),n||(n=i,s=d)));for(d=h.length,h.sort(t.Hls.comparePlaylistResolution);d--;)if(i=h[d],i.attributes&&i.attributes.RESOLUTION&&i.attributes.RESOLUTION.width&&i.attributes.RESOLUTION.height&&i.attributes.RESOLUTION.width<=o.width()&&i.attributes.RESOLUTION.height<=o.height()){a=i,s=d;break}if(s=s||0,"undefined"==typeof this.currentLevel||this.currentLevel>=s)this.currentLevel=s,this.delayLevel=0;else{if(this.currentLevel<s&&this.delayLevel<1)return this.delayLevel++,this.playlists.media();this.currentLevel=s,this.delayLevel=0}return a||n||l[0]},t.HlSoha.prototype.typeToString=function(){switch(this.type){case 0:return"LIVE";case 1:return"VOD"}},t.HlSoha.prototype.changeLevelPlaylist=function(){var e=this,t=this.playlists.master.playlists.slice();t.length<=1||(0==e.currentLevel?(e.currentLevel=1,e.playlists.media(t[1])):(e.currentLevel-=1,e.playlists.media(t[e.currentLevel])))},t.HlSoha.prototype.segLoadErrorHandler=function(){if("undefined"!=typeof this.error.status){{var e=this;e.segmentLoadError,_.keys(e.segmentXhrs_)}switch(e.error.status){case 0:case 403:case 404:case 422:if(e.cancelSegmentXhr(),e.segmentBuffer_=[],e.segmentLoadError.segIndex!==e.error.segIndex){if(3==e.segSquenceError)return;e.segSquenceError=e.error.segIndex-e.segmentLoadError.segIndex==1?e.segSquenceError+1||1:0,e.segmentLoadError.segIndex=e.error.segIndex,e.segmentLoadError.errorCount=1}else if(e.isRetrySegment=!0,e.segmentLoadError.errorCount<1)e.segmentLoadError.errorCount++;else{if(1==e.segmentLoadError.errorCount)return e.segmentLoadError.errorCount++,e.bandwidth=1,e.playlists.media(e.selectPlaylist());this.isRetrySegment=!1,e.mediaIndex++}}}if("undefined"!=typeof this.error.code)switch(this.error.code){case 4:}},t.HlSoha.prototype.manifestErrorHandler=function(){},t.HlSoha.prototype.p2pInit=function(){var e=this;e.firstSegment=!1,e.segmentLoadError={},e.isRetrySegment=!1},t.HlSoha.prototype.p2pReset=function(){var e=this;e.firstSegment=!1,e.segmentLoadError={},e.isRetrySegment=!1},t.HlSoha.isSupported=function(){return!t.Hls.supportsNativeHls&&t.Flash.isSupported()&&t.MediaSource&&e.Uint8Array&&!(!e.webkitRTCPeerConnection&&!e.mozRTCPeerConnection)},t.HlSoha.canPlaySource=function(e){var t=/^application\/(?:x-|vnd\.apple\.)mpegurl/i;return t.test(e.type)}}(window,window.videojs,document);