/*! stats.plugin - v0.0.0 - 2015-03-26
* Copyright (c) 2015 Le Dac Thanh Tuan; Licensed Apache-2.0 */
!function(a,b,c){function d(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)}function e(a){if("keypress"==a.type){var b=String.fromCharCode(a.which);return a.shiftKey||(b=b.toLowerCase()),b}return q[a.which]?q[a.which]:r[a.which]?r[a.which]:String.fromCharCode(a.which).toLowerCase()}function f(a){a=a||{};var b,c=!1;for(b in w)a[b]?c=!0:w[b]=0;c||(z=!1)}function g(a,b,c,d,e,f){var g,h,i=[],j=c.type;if(!u[a])return[];for("keyup"==j&&k(a)&&(b=[a]),g=0;g<u[a].length;++g)if(h=u[a][g],!(!d&&h.seq&&w[h.seq]!=h.level||j!=h.action||("keypress"!=j||c.metaKey||c.ctrlKey)&&b.sort().join(",")!==h.modifiers.sort().join(","))){var l=d&&h.seq==d&&h.level==f;(!d&&h.combo==e||l)&&u[a].splice(g,1),i.push(h)}return i}function h(a){var b=[];return a.shiftKey&&b.push("shift"),a.altKey&&b.push("alt"),a.ctrlKey&&b.push("ctrl"),a.metaKey&&b.push("meta"),b}function i(a,b,c,d){A.stopCallback(b,b.target||b.srcElement,c,d)||!1!==a(b,c)||(b.preventDefault?b.preventDefault():b.returnValue=!1,b.stopPropagation?b.stopPropagation():b.cancelBubble=!0)}function j(a){"number"!=typeof a.which&&(a.which=a.keyCode);var b=e(a);b&&("keyup"==a.type&&x===b?x=!1:A.handleKey(b,h(a),a))}function k(a){return"shift"==a||"ctrl"==a||"alt"==a||"meta"==a}function l(a,b,c,d){function g(b){return function(){z=b,++w[a],clearTimeout(p),p=setTimeout(f,1e3)}}function h(b){i(c,b,a),"keyup"!==d&&(x=e(b)),setTimeout(f,10)}for(var j=w[a]=0;j<b.length;++j){var k=j+1===b.length?h:g(d||m(b[j+1]).action);n(b[j],k,d,a,j)}}function m(a,b){var c,d,e,f=[];for(c="+"===a?["+"]:a.split("+"),e=0;e<c.length;++e)d=c[e],t[d]&&(d=t[d]),b&&"keypress"!=b&&s[d]&&(d=s[d],f.push("shift")),k(d)&&f.push(d);if(c=d,e=b,!e){if(!o){o={};for(var g in q)g>95&&112>g||q.hasOwnProperty(g)&&(o[q[g]]=g)}e=o[c]?"keydown":"keypress"}return"keypress"==e&&f.length&&(e="keydown"),{key:d,modifiers:f,action:e}}function n(a,b,c,d,e){v[a+":"+c]=b,a=a.replace(/\s+/g," ");var f=a.split(" ");1<f.length?l(a,f,b,c):(c=m(a,c),u[c.key]=u[c.key]||[],g(c.key,c.modifiers,{type:c.action},d,a,e),u[c.key][d?"unshift":"push"]({callback:b,modifiers:c.modifiers,action:c.action,seq:d,level:e,combo:a}))}var o,p,q={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},r={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},s={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},t={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},u={},v={},w={},x=!1,y=!1,z=!1;for(c=1;20>c;++c)q[111+c]="f"+c;for(c=0;9>=c;++c)q[c+96]=c;d(b,"keypress",j),d(b,"keydown",j),d(b,"keyup",j);var A={bind:function(a,b,c){a=a instanceof Array?a:[a];for(var d=0;d<a.length;++d)n(a[d],b,c);return this},unbind:function(a,b){return A.bind(a,function(){},b)},trigger:function(a,b){return v[a+":"+b]&&v[a+":"+b]({},a),this},reset:function(){return u={},v={},this},stopCallback:function(a,b){return-1<(" "+b.className+" ").indexOf(" mousetrap ")?!1:"INPUT"==b.tagName||"SELECT"==b.tagName||"TEXTAREA"==b.tagName||b.isContentEditable},handleKey:function(a,b,c){var d,e=g(a,b,c);b={};var h=0,j=!1;for(d=0;d<e.length;++d)e[d].seq&&(h=Math.max(h,e[d].level));for(d=0;d<e.length;++d)e[d].seq?e[d].level==h&&(j=!0,b[e[d].seq]=1,i(e[d].callback,c,e[d].combo,e[d].seq)):j||i(e[d].callback,c,e[d].combo);e="keypress"==c.type&&y,c.type!=z||k(a)||e||f(b),y=j&&"keydown"==c.type}};a.Mousetrap=A,"function"==typeof define&&define.amd&&define(A)}(window,document),function(a,b,c,d){"use strict";function e(a,b){var c;return c||(c=new i(a,b)),c}d.sayswho=function(){var a,b=d.userAgent,c=b.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(c[1])?(a=/\brv[ :]+(\d+)/g.exec(b)||[],"IE "+(a[1]||"")):"Chrome"===c[1]&&(a=b.match(/\bOPR\/(\d+)/),null!==a)?"Opera "+a[1]:(c=c[2]?[c[1],c[2]]:[d.appName,d.appVersion,"-?"],null!==(a=b.match(/version\/(\d+)/i))&&c.splice(1,1,a[1]),c.join(" "))}();var f,g={option:!0,display:!1,logging:!1,statsId:""};f=function(a){var c=b.util.mergeOptions(g,a),d=this,f=d.stats=e(c,d);f.render(),f.addListeners()};var h=_.template("<span><%= key %> : <%= value %></span>"),i=function(a,b){var c;"undefined"!=typeof Storage?(c=localStorage.getItem("sohatvID"),c||(c=this.generateUUID(),localStorage.setItem("sohatvID",c))):c=localStorage.getItem("sohatvID"),this.player_=b,this.template={stats:_.template('<div data-p2phlsstats class="p2phlsstats"><p>sohatv stats</p><%= span %><div>'),CSS:{stats:'@font-face{font-family:StatsFont;src:url(http://cdn.clappr.io/bemtv/latest/assets/visitor.eot);src:url(http://cdn.clappr.io/bemtv/latest/assets/visitor.eot?#iefix) format("embedded-opentype"),url(http://cdn.clappr.io/bemtv/latest/assets/visitor.ttf) format("truetype"),url(http://cdn.clappr.io/bemtv/latest/assets/visitor.svg#player) format("svg")}.p2phlsstats[data-p2phlsstats]{font-family:StatsFont;position:absolute;text-align:left;z-index:9999;top:20px;left:20px;font-smooth:never;-webkit-font-smoothing:none;background-color:rgba(0,0,0,.7);color:#fff;border-radius:3px;width:155px;height:203px;padding-top:11px;font-size:10px;padding-left:5px}.p2phlsstats[data-p2phlsstats] p{color:#fff;text-align:center;margin-bottom:5px}.p2phlsstats[data-p2phlsstats] span{color:#fff;display:block;text-align:left;margin-bottom:3px;line-height:1em}.p2phlsstats[data-p2phlsstats] span.stats-status{display:inline}'}},this.state={fReport:0},this.settings=a,this.metrics={userID:c,src:"",browser:d.sayswho,tech_name:"",seek:0,current_time:0,duration:0},this.recordReport={userID:c,src:"",techName:"",seek:[],tsTimeOut:{},loading:[],duration:0},this.adsReport={userID:c,src:"",skipAdd:0,waitting:{}},this.error=[],this.settings.logSoha&&(this.settings.logURL=this.settings.logAdsURL=this.settings.errorURL=this.settings.logSoha)};i.prototype.render=function(){var b=this.player(),c=this,d=a(b.el()),e="",f=a('<style class="adSoha-style"></style>').html(c.template.CSS.stats)[0];_.map(c.metrics,function(a,b){e+=h({value:a,key:b}).replace(/_/g," ")}),c.$el=a('<div class="sohatv-stats"></div>').html(c.template.stats({span:e})),c.settings.display||c.hide(),d.append(f),d.append(c.$el)},i.prototype.addListeners=function(){var a=this.player(),d=this;c.bind(["command+shift+s+v","ctrl+shift+s+v"],b.bind(this,this.showOrHide)),(d.settings.logging&&(d.settings.logAdsURL||d.settings.logURL)||d.settings.display)&&(a.on("durationchange",b.bind(this,this.onStatsReport)),a.on("play",b.bind(this,this.onStatsReport)),a.on("seeking",b.bind(this,this.onStatsReport)),a.on("seeked",b.bind(this,this.onStatsReport)),a.on("timeupdate",b.bind(this,this.onStatsReport)),a.on("waiting",b.bind(this,this.onStatsReport)),a.on("ended",b.bind(this,this.onStatsReport))),d.settings.logging&&d.settings.logAdsURL&&a.on("skipAds",b.bind(this,this.onStatsReport)),d.settings.errorURL&&a.on("error",b.bind(this,this.sendError))},i.prototype.showOrHide=function(){var a=this;a.$el.hasClass("vjs-hidden")?a.show():a.hide()},i.prototype.onStatsReport=function(a){var b=this.player(),c=this,d=b.tech,e=c.metrics,f={},g={},h={},i=c.ads(),j=0,k=[20,40,60,80];switch(i?(f=c.adsReport,g=c.sendStatsAds.bind(c)):(f=c.recordReport,g=c.sendStats.bind(c)),a.type){case"timeupdate":var l=f.currentTime=b.currentTime().toFixed(2),m=b.player(),n=f.buffered=(b.buffered().end(0)-b.currentTime()).toFixed(2);if(e.current_time=l,e.buffered=f.buffered,i)return;switch(f.techName=b.techName,e.tech_name=b.techName,b.techName){case"HlSoha":var o=Math.ceil(d.bandwidth/8/1024);if(f.minBandwidth=f.minBandwidth||o,f.maxBandwidth=f.maxBandwidth||o,e.minBandwidth=f.minBandwidth=f.minBandwidth>o&&1!==o?o:f.minBandwidth,e.maxBandwidth=f.maxBandwidth=f.maxBandwidth<o?o:f.maxBandwidth,e.bytesReceived=f.bytesReceived=d.bytesReceived,e.type=f.type=d.typeToString(),l>0&&m>l&&Math.abs(n)<.5&&Math.abs(l-j)>10){j=l;var p=d.playlists.media().segments[d.mediaIndex];p&&f.loading.push({currentTime:l,segment:p})}}var q=Math.ceil(100*l/m);-1!==k.indexOf(q)&&c.state.fReport!==q&&(c.state.fReport=q,g());break;case"waiting":if(i)return;break;case"seeked":if(i)return;switch(b.techName){case"Hls":case"HlSoha":h.currentTime=b.currentTime(),h.segment=d.playlists.media().segments[d.mediaIndex];break;case"Html5":h.currentTime=b.currentTime()}f.seek.push(h),e.seek=f.seek.length;break;case"play":f.src=b.currentSrc(),e.duration=f.duration=b.duration().toFixed(2),e.src=f.src.split("/").pop(),g();break;case"ended":g();break;case"skipAds":f.skipAdd++}c.updateMetrics()},i.prototype.show=function(){this.$el.removeClass("vjs-hidden")},i.prototype.player=function(){return this.player_},i.prototype.hide=function(){this.$el.addClass("vjs-hidden")},i.prototype.updateMetrics=function(){var a=this,b="";_.map(a.metrics,function(a,c){b+=h({value:a,key:c}).replace(/_/g," ")}),this.$el.html(a.template.stats({span:b}))},i.prototype.generateUUID=function(){var a=(new Date).getTime(),b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"===b?c:3&c|8).toString(16)});return b},i.prototype.sendStats=function(){if(this.settings.logURL){var b="?log="+JSON.stringify(this.recordReport),c=this.settings.logURL+b;a.ajax({url:c})}},i.prototype.sendStatsAds=function(){if(this.settings.logAdsURL){var b="?logAds="+JSON.stringify(this.adsReport),c=this.settings.logAdsURL+b;a.ajax({url:c})}},i.prototype.sendError=function(){var b=this.player(),c=this;c.error.push(b.error_);var d="?error="+JSON.stringify(c.adsReport),e=this.settings.errorURL+d;a.ajax({url:e})},i.prototype.ads=function(){var a=this.player();if("object"!=typeof a.ads)return!1;var b=a.ads.snapshot||{};return b.src===a.currentSrc()?!1:!0},b.plugin("stats",f)}(jQuery,window.videojs,window.Mousetrap,window.navigator);